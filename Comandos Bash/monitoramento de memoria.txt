Mãos na massa: monitorando o consumo de memória com scripts
 Próxima Atividade

O servidor que sua equipe está utilizando está apresentando uma certa lentidão. Para entender o que está ocorrendo, você precisa analisar os processos que estão consumindo maior memória ao longo do dia.

Um colega da equipe sugeriu a criação de um script que identifique os 15 processos com maior consumo de memória a cada 5 minutos e armazene o resultado em um arquivo. Como você tem atuado na elaboração de scripts e automação de tarefas, essa tarefa ficou sob sua responsabilidade.

Vamos praticar?
Implemente o script que identifique os 15 processos com maior consumo de memória em um dado instante usando os comandos ps, grep e head(utilize o pipe para direcionar a saída de um comando como entrada para outro) e, na sequência, agende a execução do script utilizando o crontab.

Ver opinião do instrutor
Opinião do instrutor

Vamos entender um script que soluciona a demanda da sua equipe:

#!/bin/bash

# Definimos o caminho para o arquivo de saída
output_file="/caminho/do/seu/diretorio/top_processes_$(date +\%Y\%m\%d_\%H\%M).txt"

# Listamos os 15 processos com maior consumo de memória e salvamos no arquivo de saída
ps -e -o pid,%mem --sort=-%mem | head -n 16 > "$output_file"
Copiar código
Observe que a variável output_file representa o caminho completo para o arquivo de saída. O nome do arquivo inclui a data e hora atual formatada.

O comando ps lista todos os processos do sistema, a opção -e indica que queremos listar todos os processos em execução e a opção -o pid,%mem especifica as informações (colunas da tabela de resultados) que desejamos exibir na saída. Em nosso caso, PID (número de identificação do processo) e percentual de memória utilizado (%). Por fim, o --sort=-%mem é usado para ordenar a saída com base no percentual de memória, em ordem decrescente. O sinal de menos (-) antes de %mem indica a ordenação de modo decrescente.

Então, usamos | (pipe) para encaminhar esse resultado de saída para o comando head -n 16 que irá selecionar apenas os 15 primeiros processos listados. Note que usamos -16, pois a primeira linha é geralmente ocupada pelo cabeçalho da tabela.

O resultado é do head é então redirecionado para o arquivo especificado pela variável output_file.

Para agendar a execução do script a cada 5 minutos, basta adicionar uma entrada no crontab. Podemos executar o comando crontab -e para editar o crontab e adicione a seguinte linha:

*/5 * * * * /caminho/do/script.sh
